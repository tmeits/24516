####  Using neural network for create regression CLIs-CRNs
  + <https://yandex.ru/maps/-/CZslE6LZ>
  + <iframe src="https://api-maps.yandex.ru/frame/v1/-/CZslE6LZ" width="560" height="400" frameborder="0"></iframe>
  + <http://pc70.gvc.gu.se/oth/PDFs/Linderholmetal2013.pdf>
  + <install.packages('treeclim', dependencies=TRUE, repos='http://cran.rstudio.com/')>

russ055 Khotugn-Uladan-Tukulan 63.38 125.80 100 Pinus sp. 28 1687 1991 305 257.3 0.65 F Schweingruber
```{r init}
rm(list=ls())
assign("last.warning", NULL, envir = baseenv())
source("http://tmeits.github.io/24516/transect/setdw.R")
mod_data <- url("http://tmeits.github.io/24516/transect/cli/MT.Rdata")
load(mod_data)
```
#### Read Ivan CRNs for transect

  + <https://www.ncdc.noaa.gov/paleo/meas_table.html>
```{r read_rwi_data}
Sys.setenv(R_ZIPCMD = paste0(mm_path, "/bin/zip.exe"))  # path to zip.exe
require(openxlsx)  

russ055.rwi <- openxlsx::read.xlsx(paste0(nnet_path, "/neuralnet_aisori/russ055.xlsx"),
    sheet = 1, startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
    skipEmptyRows = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
    namedRegion = NULL)
str(russ055.rwi)
summary(russ055.rwi)
plot(russ055.rwi, main ="Chronology RUSS055") 
lines(russ055.rwi)  

require(ggplot2) # http://ggplot2.org/book/qplot.pdf 
qplot(year, rwi, data=russ055.rwi, geom = c("point","smooth"))
qplot(year, rwi, data=russ055.rwi, geom = c("point","line","smooth"), colour = "RUSS055")
qplot(year, rwi, data=russ055.rwi, geom = c("boxplot"), colour = "RUSS055")
qplot(year, rwi, data=russ055.rwi, geom = ""density")
```
#### 
```{r set_24643}
load(file=paste0(nnet_path, "/MM.Rdata"))
traininginput <- as.data.frame(MM)
# Changing column names of a data frame
N<-c("Station", "Year", "Cli_m1", "Cli_m2", "Cli_m3", "Cli_m4", "Cli_m5", "Cli_m6", "Cli_m7", "Cli_m8",  "Cli_m9", "Cli_m10", "Cli_m11", "Cli_m12")
names(traininginput) <- N
MT <-traininginput 
unique(MT$Station)
save(MT, file=paste0(nnet_path, "/MT.Rdata"))

```
#### Compare the annual growth rings on the stations and years with climate data
```{r neuralnet_crn}
library(neuralnet)
library(NeuralNetTools)
set.seed(1410) # Make the sample reproducible
traininginput <- MT
traininginput <- traininginput[traininginput$Station == 24643, ]
str(traininginput)
summary(traininginput)
plot(traininginput[2:14])
trainingoutput <- russ055.rwi[russ055.rwi$year >= min(traininginput$Year) & russ055.rwi$year <= max(traininginput$Year), ]
str(trainingoutput)
summary(trainingoutput)
# https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf
qplot(1:12, sapply(traininginput[3:14], mean), geom = c("point", "smooth"))
plot(1:12, sapply(traininginput[3:14], mean), geom = c("point", "smooth"))

L <- length(traininginput[, 1])
# the generated synthetic growth
trainingoutput <- as.vector(runif(L, 0.3, 1.9))

# http://dendrobox.org/
trainingdata <- cbind(traininginput, CRN = trainingoutput)
trainingdata.sample <- trainingdata[, 3:15]
# Train the neural network
net.crn <- neuralnet(CRN ~ Cli_m1 + Cli_m2 + Cli_m3 + Cli_m4 + Cli_m5 + 
    Cli_m6 + Cli_m7 + Cli_m8 + Cli_m9 + Cli_m10 + Cli_m11 + Cli_m12, trainingdata.sample, 
    hidden = c(11,41,21, 41, 11), rep = 1, linear.output = TRUE, threshold = 0.1, stepmax = 100000)
    

# https://rdrr.io/cran/neuralnet/man/neuralnet.html    
net.crn <- neuralnet(CRN ~ Cli_m1 + Cli_m2 + Cli_m3 + Cli_m4 + Cli_m5 + 
    Cli_m6 + Cli_m7 + Cli_m8 + Cli_m9 + Cli_m10 + Cli_m11 + Cli_m12, trainingdata.sample, 
    hidden = c(7, 11), threshold = 0.01, stepmax = 100000, rep = 1, startweights = NULL, 
    learningrate.limit = NULL, learningrate.factor = list(minus = 0.5, plus = 1.2), 
    learningrate = NULL, lifesign = "none", lifesign.step = 1000, algorithm = "rprop+", 
    err.fct = "sse", act.fct = "logistic", linear.output = TRUE, exclude = NULL, 
    constant.weights = NULL, likelihood = FALSE)

# Save the neural network
save(net.crn, traininginput, trainingoutput, trainingdata, trainingdata.sample, file=paste0(nnet_path, "/net.Rdata"))
load(file=paste0(nnet_path, "/net.Rdata"))
# Plot the neural network
plot(net.crn, rep="best")
plotnet(net.crn, alpha=0.6)
#prediction(net.crn)
gwplot(net.crn, selected.covariate="Cli_m5")
gwplot(net.crn)
```
#### 

  + <https://rdrr.io/cran/neuralnet/> 
```{r neuralnet}
library(neuralnet)
library(NeuralNetTools)

# Make up some new data
n <- 65
mint <- -40
maxt <-40
traininginput <- data.frame(m1 = runif(n, mint, maxt), m2 = runif(n, mint, maxt), 
    m3 = runif(n, mint, maxt), m4 = runif(n, mint, maxt), m5 = runif(n, 
        mint, maxt), m6 = runif(n, mint, maxt), m7 = runif(n, mint, maxt), 
    m8 = runif(n, mint, maxt), m9 = runif(n, mint, maxt), m10 = runif(n, 
        mint, maxt), m11 = runif(n, mint, maxt), m12 = runif(n, mint, 
        maxt))
traininginput<-round(traininginput,2)
trainingoutput<-apply(traininginput, 1, function(x) sqrt(abs(sum(x))))
trainingoutput<-as.vector(trainingoutput)  # CRN

 
#Column bind the data into one variable
trainingdata <- cbind(traininginput, CRN=trainingoutput)
#colnames(trainingdata) <- c("Input","Output")
 
#Train the neural network
#Going to have 10 hidden layers
#Threshold is a numeric value specifying the threshold for the partial
#derivatives of the error function as stopping criteria.
net.crn <- neuralnet(CRN~m1+m2+m3+m4+m5+m6+m7+m8+m9+m10+m11+m12,trainingdata, hidden=c(15), rep = 1, linear.output = TRUE, threshold=0.01)



print(net.crn)
#par(mar = numeric(4), family = 'serif')
plotnet(net.crn, alpha=0.6) 
#Plot the neural network
plot(net.crn)
 
#Test the neural network on some training data
testdata <- as.data.frame(trainingoutput[12:45]) 
testdata <-traininginput[10:25,]
net.results <- compute(net.crn, testdata) #Run them through the neural network
 
#Lets see what properties net.sqrt has
ls(net.results)
 
#Lets see the results
print(net.results$net.result)
 
#Lets display a better version of the results
cleanoutput <- cbind(testdata, trainingoutput[10:25], as.data.frame(net.results$net.result))
#colnames(cleanoutput) <- c("Input","Expected Output","Neural Net Output")
print(cleanoutput)

plot(trainingoutput[10:25], net.results$net.result)

plot(BostonHousing$medv, nnet.predict, main="Neural network predictions vs actual", xlab="Actual")

```
```{r plot_net}
library(neuralnet)
 
#response
CRN<-c(rep(0,7),1)
OR<-c(0,rep(1,7))
 
#response with predictors
binary.data<-data.frame(expand.grid(c(0,1),c(0,1),c(0,1)),CRN,OR)
colnames(binary.data) <- c("Temp","Prec","Soil","CRN","OR")
 
#model
net<-neuralnet(CRN~Temp+Prec+Soil, binary.data,hidden=c(6,12,8),rep=10,err.fct="ce",linear.output=FALSE)
 
#plot ouput
par(mar=numeric(4),family='serif')
plotnet(net)

```
```{r tips}
# http://web.utk.edu/~grissino/software.htm#dendrometer
# https://toster.ru/q/79828
# http://matlab.exponenta.ru/neuralnetwork/book1/task1/task1.php
# https://www.r-bloggers.com/fitting-a-neural-network-in-r-neuralnet-package/
# https://heuristically.wordpress.com/2011/11/17/using-neural-network-for-regression/
# https://www.r-bloggers.com/general-regression-neural-network-with-r/
# http://gekkoquant.com/2012/05/26/neural-networks-with-r-simple-example/
# https://rpubs.com/mbaumer/NeuralNetworks
# https://beckmw.wordpress.com/2014/12/20/neuralnettools-1-0-0-now-on-cran/
# https://bzstat.wordpress.com/2011/07/10/using-lib-fann-in-r-via-rcpp/
# install.packages('NeuralNetTools', dependencies=TRUE, repos='http://cran.rstudio.com/')
# install.packages('neuralnet', dependencies=TRUE, repos='http://cran.rstudio.com/')
```
