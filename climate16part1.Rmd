---
title: "Пример использования метода главных компонент и дискриминантного анализа для реконструкции термических характеристик сезона роста по клеточным измерениям годичных колец."
author: "Iljin Victor"
date: '26 августа 2016 г '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Очистка памяти 

```{r clear_all}
rm(list=ls()); cat("\014")
```

## Чтения файла с данными BG1 and EG1 (Margarita)

```{r read_datasets}
if(R.version$os == "linux-gnu"){ mm_path <- '/home/larisa/Dropbox/24516/'
} else { mm_path <- 'C:/Users/IVA/Dropbox/24516/' }
setwd(mm_path)
schc <- read.csv(
  paste(mm_path, '1936_2009.dat', sep = ''), 
  header = TRUE, sep = "", dec = ".")
head(schc); str(schc) # summary(schc); cor(schc)
plot(schc$year, schc$BG1, col = "red", ylim = c(90, 300), ylab = "day", xlab = "year")
lines(schc$year, schc$BG1, col = "red",type = "l")
lines(schc$year, schc$EG1, col = "blue",type = "p")
lines(schc$year, schc$EG1, col = "blue",type = "l")

schc$EG1-schc$BG1
```

## Чтение размеров клеток по деревьям и годам (малая минуса)
  + таблица с данными кластеризованна на три кластера

```{r read_cells_datasets}

sm <- read.csv(
  paste(mm_path, 'small_minusa_lda_sep_3.csv', sep = ''), 
  header = TRUE, sep = ";", dec = ",") # Pinus sylvestris L.
# Округлим результаты для лучшего восприятия данных
sm_round <- round(sm, digits = 2)
head(sm_round)
```
#### Чтение данных из датасета участка Малая Минуса и климатических данных участка Малая Минуса
* Работаем с метеоданными <http://aisori.meteo.ru/ClimateR> в [R]
* Конвертируем данные метеостанции 29866 53.42N 91.42E по температуре для работы в data.frame [R] 
  + Удаляем качество замера
  + Присваиваем столбцам наименования
  + Разделяем по разным таблицам метеостанцию Minusinsk.cli и Hakasskaja.cli 

```{r read_cli_datasets}
sm.cli <- read.csv(
  paste(mm_path, 'cli/SCH231.txt', sep = ''), 
  header = FALSE, sep = ";", dec = ".") # Climate
sm.cli <- sm.cli[-c(5, 7, 9, 11, 13, 14)] # Удаляем лишние столбцы
sm.cli <- setNames(sm.cli, c("Station", "Year", "Month", "Day",  'TMIN','TMEAN','TMAX','PRECIP'))
# 53.42N 91.42E
Minusinsk.cli <- sm.cli[sm.cli$Station == 29866, ]
# 53.46N 91.19E 
Hakasskaja.cli <- sm.cli[sm.cli$Station == 29862, ]
Minusinsk.cli.1964.2013 <- Minusinsk.cli[
  (Minusinsk.cli$Year >= 1964) & (Minusinsk.cli$Year <= 2013), ]
head(Minusinsk.cli.1964.2013); str(Minusinsk.cli.1964.2013)
```

## Исходные температурные данные сглаживались при помощи метода скользящих средних с окном в 43 дня.

Подобного рода сглаживание проводилось с целью избавления от «случайных» температурных флуктуаций. При дальнейшем увеличении окна внутренняя корреляционная структура полученных характеристик по годам не меняется.

<http://r-analytics.blogspot.ru/2012/09/blog-post_6280.html#.V4WLmPuLYbe>
<http://www.inside-r.org/packages/cran/pracma/docs/movavg>

```{r temperature_smoothed}
# > install.packages("pracma")
# http://matlab.exponenta.ru/curvefitting/3_10.php
#library(pracma)
source(paste(mm_path, "movavg.R", sep = ''))
source(paste(mm_path, "rand.R", sep = ''))
source(paste(mm_path, "size.R", sep = ''))
# lsb_release -a
# https://cran.r-project.org/bin/linux/ubuntu/
# синтетический тест
X <- seq(0,5, by = 0.0003); length(X)
Y <- X*sin(3*X) + 2*randn(size(X))
plot(X, Y, col = "blue")
T <- movavg(Y, 33, type = "t")
T2 <- movavg(Y, 191, type = "t")
lines(X, T, col = "red", lwd = "3")
lines(X, T2, col = "green", lwd = "3")
grid(NA, 5, lwd = 2)
lines(lowess(X, Y, f=0.05, iter = 4, delta = 0.01 * diff(range(X))), 
        lwd = 5, col = "grey")
```

```{r synt}
# > install.packages("pracma")
# http://matlab.exponenta.ru/curvefitting/3_10.php
#library(pracma)
source(paste(mm_path, "movavg.R", sep = ''))
source(paste(mm_path, "rand.R", sep = ''))
source(paste(mm_path, "size.R", sep = ''))
# lsb_release -a
# https://cran.r-project.org/bin/linux/ubuntu/
# синтетический тест
X <- seq(0,5, by = 0.0003); length(X)
Y <- X*sin(3*X) + 2*randn(size(X))
plot(X, Y, col = "blue")
T <- movavg(Y, 33, type = "t")
T2 <- movavg(Y, 191, type = "t")
lines(X, T, col = "red", lwd = "3")
lines(X, T2, col = "green", lwd = "3")
grid(NA, 5, lwd = 2)
lines(lowess(X, Y, f=0.05, iter = 4, delta = 0.01 * diff(range(X))), 
        lwd = 5, col = "grey")
```

```{r ggplot2}
# install.packages("ggplot2")
# http://qsar4u.com/files/rintro/06.html
# https://gist.github.com/aa989190f363e46d/e65b46dcba8874a202fe
require(ggplot2)
X <- seq(0,5, by = 0.001); length(X)
Y <- X*sin(3*X) + 2*randn(size(X))
g1 <- qplot(x = X, y = Y[1,], geom = "point")
g1
```
## Служебные функции
```{r getyear}
get_one_year <- function(years, now) {
  #
  return(years[years$Year == now, ])
}
Y64 <- get_one_year(Minusinsk.cli, 1964)

season_growth <- function(sgs, s.year) {
  #
  return(c(sgs[sgs$year == s.year, ]$BG1, sgs[sgs$year == s.year, ]$EG1))
}
S64 <- season_growth(schc, 1964)
```
## Для каждого года были рассчитаны 16 климатических характеристик (Табл. 2.7.1), что позволило охарактеризовать каждый сезон роста 16-мерным вектором.

  + Климатические характеристики, рассчитанные по ежедневным данным температуры и осадков по метеостанции в районе

<http://www.inp.nsk.su/~baldin/DataAnalysis/R/R-03-datatype.pdf>
<http://www.stat.berkeley.edu/classes/s133/dates.html>
<http://www.statmethods.net/advstats/timeseries.html>
```{r calculated_climatic_characteristics}

# Сумма температур выше 0C до 22 июня
T220 <- 
# Сумма температур выше 5C до 22 июня
T225 <- 
# Сумма температур от 22 июня до перехода через 0C в конце сезона
FT220 <- 
# Сумма температур от 22 июня до перехода через 5C в конце сезона
FT225 <- 
# Скорость подъема температуры
SPEEDT <- 

```
## 
```{r SUMT12C}
# функция преобразующая дату в количество дней с начала года
num_days <- function(year, month, day) {
  D1 <- as.Date(paste(year, "-1-1", sep = ""))
  asd <- as.Date(paste(year, "-", month, "-", day, sep = ""))
  return(as.numeric(difftime(asd, D1, units = "day")))
}
num_days(1964, 6, 22)
```

``` {r SUMT0}
# Сумма температур больше 0C - Сумма температур больше 5C
SUMT0 <- function (data.cli, data.calc, s.year, temp.c = 0) {
  year <- get_one_year(data.cli, s.year)
  sum_temp <- 0
  for(i in 1: length(year[, 1])) {
    if(year[i, ]$TMEAN > temp.c) {
      sum_temp <- sum_temp + year[i, ]$TMEAN
    }
  }
  return(sum_temp)
}
# test
sum_temp <- SUMT0(Minusinsk.cli, schc, 1965, 0); sum_temp
sum_temp <- SUMT0(Minusinsk.cli, schc, 1965, 5); sum_temp
```

```{r inter0}
# Длительность сезона от 0C до 0C или от 5C до 5C
INTER0 <- function (data.cli, data.calc, s.year, temp.c = 0) {
  year <- get_one_year(data.cli, s.year)
  sg   <- season_growth(data.calc, s.year)
  lbeg <- STDAT0(data.cli, data.calc, s.year, temp.c)
  lend <- FDAT0(data.cli, data.calc, s.year, temp.c)

  startdate <- as.Date(paste(as.character(lbeg[3]), "-", as.character(lbeg[2]), "-",
                      as.character(lbeg[1]), sep = ''))
  enddate   <- as.Date(paste(as.character(lend[3]), "-", as.character(lend[2]), "-",
                      as.character(lend[1]), sep = ''))
  # http://distrland.blogspot.ru/2015/04/r-2-date-base-r.html
  days      <- as.numeric(difftime(enddate , startdate, units = "day"))
  
  # install.packages("timeDate")
  # https://journal.r-project.org/archive/2011-1/RJournal_2011-1_Chalabi~et~al.pdf
  return(days)
}
INTER0(Minusinsk.cli, schc, 1965, 0)
INTER0(Minusinsk.cli, schc, 1969, 5)

```

```{r stdat0}
# Дата перехода через 0C-5C в начале сезона роста
STDAT0 <- function (data.cli, data.calc, s.year, temp.c = 0) {
  year <- get_one_year(data.cli, s.year)
  sg <- season_growth(data.calc, s.year)
  data.0c <- c(1, 1, 1)
  for(i in 1: length(year[, 1])) {
    if(year[i, ]$TMEAN > temp.c & i >= sg[1]) {
      data.0c[3] <- year[i, ]$Year
      data.0c[2] <- year[i, ]$Month
      data.0c[1] <- year[i, ]$Day
      return(data.0c)
    }
  }
  stop("В вечной мерзлоте деревья не растут. Проверьте климатику.")
}
STDAT0(Minusinsk.cli, schc, 1965)
STDAT0(Minusinsk.cli, schc, 1965, 5) # Дата перехода через 5C в начале сезона роста STDAT5
```

```{r fdat0}
# Дата перехода в конце сезона через 0C-5C
FDAT0 <- function (data.cli, data.calc, s.year, temp.c = 0) {
  year <- get_one_year(data.cli, s.year)
  sg <- season_growth(data.calc, s.year)
  data.0c <- c(1, 1, 1)
  for(i in sort(1: length(year[, 1]), decreasing = TRUE)) {
    if(year[i, ]$TMEAN >= temp.c & i <= sg[2]) {
      data.0c[3] <- year[i, ]$Year
      data.0c[2] <- year[i, ]$Month
      data.0c[1] <- year[i, ]$Day
      return(data.0c)
    }
  }
  stop("В вечной мерзлоте деревья не растут. Проверьте климатику.")
}
FDAT0(Minusinsk.cli, schc, 1965)
FDAT0(Minusinsk.cli, schc, 1965, 5)
```

```{r sumprec}
# Сумма осадков в течение сезона роста
SUMPREC <- function (data.cli, data.calc, s.year) {
  new.year <- na.omit(get_one_year(data.cli, s.year))
  sg <- season_growth(data.calc, s.year)
  print(sg)
  return(sum(new.year$PRECIP[sg[1]: sg[2]]))
}
SUMPREC(Minusinsk.cli, schc, 1964)
```

```{r maxtemp}
# Максимум температуры
MAXT <- function(data.cli, s.year) {
  return(max(data.cli[data.cli$Year == s.year, ]$TMAX))
}
MAXT(Minusinsk.cli, 1964)
```

```{r datemax}
# Дата достижения максимума температуры
MDAT <- function(data.cli, s.year) {
  temp.max <- -99
  data.max <- c(1, 1, 1)
  year <- get_one_year(data.cli, s.year)
  for(i in 1: length(year[, 1])) {
    if(year[i, ]$TMAX > temp.max) {
      temp.max <- year[i, ]$TMAX
      data.max[3] <- year[i, ]$Year
      data.max[2] <- year[i, ]$Month
      data.max[1] <- year[i, ]$Day
    }
  }
  return(list(data.max, temp.max))
}
MDAT(Minusinsk.cli, 1964)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

<https://glvrd.ru>
<http://www.bioclass.ru/files/R_0_3.pdf>



read 
http://distrland.blogspot.ru/2016/05/ggplot2_21.html#more
http://distrland.blogspot.ru/2016/05/ggplot2.html#more
http://distrland.blogspot.ru/2016/04/k-k-nearest-neighbors-r.html#more
http://distrland.blogspot.ru/2016/03/ggplot2.html#more
http://distrland.blogspot.ru/2016/02/r-8-yahoo-r.html#more
http://distrland.blogspot.ru/2015/02/r.html#more
http://distrland.blogspot.ru/2014/12/excel-r.html#more
http://distrland.blogspot.ru/2014/12/r.html#more

