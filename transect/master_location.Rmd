### Summary table on climate stations
#### Iljin Victor, 13.10.2016
```{r master_location}
source("https://raw.githubusercontent.com/tmeits/24516/master/transect/set_work_dir.R")
st.names <- c("Station_Code", "Station_Name", "Latitude", "Longitude", "Elevation", "Start_Y", 
    " End_Y")
st.names.alt <- c("wmo_xref", "city", "lat_prp", "lon_prp", "elev_baro", "start_year", "end_year")
# http://meteocenter.net/_world_weather_stations.htm
st <- read.csv("master-location-identifier-database-20130801.csv", header = TRUE, sep = ",", 
    dec = ".")
altai.code <- c(29998, 36229, 36231, 36246)
altai.names <- c("ORLIK", "UST-KOKSA", "ONGUDAJ", "UST-ULAGAN")
sort(altai.code)
# Work with weather data <http://aisori.meteo.ru/ClimateR> [R]
altai.aisori.files <- c("NA", "1", "NA", "NA")
altai.files <- list.files(path = "cli/altai")

lena.files <- list.files(path = "cli/lena")
lena.code <- c("24051", "24261", "24643", "24652", "24668", "24768", "24859")
sort(lena.code)

lf <- list.files(path = "cli/north")
north.files <- list.files(path = "cli/north")
north.code <- c(1:length(lf))
for (i in 1:length(lf)) {
    lf.ss <- substr(lf[i], 1, 5)
    north.code[i] <- as.numeric(lf.ss)
    cat(lf.ss, "\n")
}
sort(north.code)

lf <- list.files(path = "cli/yenisei")
yenisei.files <- list.files(path = "cli/yenisei")
yenisei.code <- c(1:length(lf))
for (i in 1:length(lf)) {
    lf.ss <- substr(lf[i], 1, 5)
    yenisei.code[i] <- as.numeric(lf.ss)
    cat(lf.ss, "\n")
}
sort(yenisei.code)

getStationInfo <- function(stDF, stCode) {
    L <- length(stDF[, 1])
    for (i in 1:L) {
        if (!is.na(stDF[i, 12])) {
            # stDF$wmo_xref[i]
            if (stDF[i, "wmo_xref"] == stCode) 
                return(stDF[i, ])
        }
    }
}
# http://www.latlong.ru/
# http://www.sur-base.ru/?p=map
# http://meteoclub.ru/index.php?action=vthread&forum=16&topic=4021
all.code <- c(altai.code, lena.code, north.code, yenisei.code)
all.code <- sort(as.numeric(all.code))
all.code
length(all.code)
ML <- matrix(c(1:(length(all.code) * 7)), nrow = length(all.code), ncol = 7, byrow = TRUE)
ml.df <- as.data.frame(ML)  #  converted to dataframe
ml.df <- setNames(ml.df, st.names)
ml.df <- setNames(ml.df, st.names.alt)  # assign names to the columns
str(ml.df)
for (i in 1:length(all.code)) {
    si <- getStationInfo(st, all.code[i])
    cat(si$wmo, as.character(si$city), round(si$lat_prp, 2), round(si$lon_prp, 2), si$elev_baro, 
        "\n")
    ml.df[i, 1] <- si$wmo
    ml.df[i, 2] <- as.character(si$city)
    ml.df[i, 3] <- round(si$lat_prp, 2)
    ml.df[i, 4] <- round(si$lon_prp, 2)
    ml.df[i, 5] <- si$elev_baro
    ml.df[i, 6] <- NA
    ml.df[i, 7] <- NA
    if(all.code[i] == 24152){
    ml.df[i, 5] <- 3
       ml.df[i, 2] <- "XZ}"
    }
    if(all.code[i] == 38401)  ml.df[i, 5] <- 3
    if(all.code[i] == 23077)  ml.df[i, 5] <- 2
}
str(ml.df)
ml.df.backup <- ml.df
```
#### Read the files at the stations and determination of years
```{ read}

addPeriod <- function(dfPTransect, path, listFiles) {
    dfTransect <- dfPTransect
    for (i in 1:length(listFiles)) {
        Al <- read.csv(paste0(path,listFiles[i]), header = FALSE, sep = "", dec = ".")
        cat("\nRead (", i, ")", listFiles[i], "\n")
        cat(Al[length(Al[,3]), 3],  Al[1, 3], "\n")
        dfTransect[dfTransect$wmo_xref == as.numeric(substr(listFiles[i], 1, 5)), ]$end_year <- Al[length(Al[, 3]), 3]
        dfTransect[dfTransect$wmo_xref == as.numeric(substr(listFiles[i], 1, 5)), ]$start_year <- Al[1, 3]
    }
    return(dfTransect)
}
ml.df <- ml.df.backup
ml.df <- addPeriod(ml.df, paste0(getwd(), "/cli/altai/"), altai.files)
ml.df <- addPeriod(ml.df, paste0(getwd(), "/cli/lena/"), lena.files)
ml.df <- addPeriod(ml.df, paste0(getwd(), "/cli/north/"), north.files)
ml.df <- addPeriod(ml.df, paste0(getwd(), "/cli/yenisei/"), yenisei.files)
head(ml.df) 
print("Read done...")
```
#### writeXLSX
```{r writeXLSX}
Sys.setenv(R_ZIPCMD = paste0(getwd(), "/bin/zip.exe"))  ## path to zip.exe
require(openxlsx)
openxlsx::write.xlsx(ml.df, file = "master_location.xlsx")


print("Write done...")
```
To refer to the array: 

Bulygina O. N., Veselov V. M., Alexandrova, T. M., Korshunova N. N. "DESCRIPTION OF ARRAY DATA ON ATMOSPHERIC PHENOMENA AT THE METEOROLOGICAL STATIONS OF RUSSIA."
The certificate of state registration database No. 2015620081
<http://meteo.ru/data/345-atmosfernye-yavleniya-sroki>

```{r}
#runAllChunks("master_location.Rmd")
print("End.")
```
