***
###  The calculation of the sixteen climatic characteristics for all of the weather stations included in the transect
#### Iljin Victor, 3.11.2016
***
  + download scripts with calculation functions
  + reading climate data of the weather station
  + cleaning missing values 
  + The calculation of climatic parameters
  + Record results in a spreadsheet 

```{r init_source, echo=FALSE}
# To display the output of a code chunk but not the underlying R code, you specify the echo=FALSE option:
rm(list=ls())
assign("last.warning", NULL, envir = baseenv())
source("http://tmeits.github.io/24516/transect/setdw.R")
source("clifiles.R")
source_transect <- function() {
    Rmd2R("transect.Rmd", "transect.R")
    source("transect.R")
    Rmd2R("cli2par.Rmd", "cli2par.R") 
}

# source_transect()
# source("cli2par.R")

cat("downloadable list of files containing climatic measurements\n")

```
### The calculation of the sixteen climatic characteristics

```{r cli2par, echo=FALSE}
#  Reading a specific year, specific weather stations
getCliStation <- function(path, fileName) {
    S <- read.csv(paste0(path, fileName), header = FALSE, sep = "", dec = ".")
    S <- setNames(D, c("Day", "Month", "Year", "PRECIP", "TMEAN"))
    return(S)
}
# main function
cli2par <- function(path, listFiles, info = TRUE, methodNA = TRUE) {
    resultT <- list()
    for (i in 1:length(listFiles)) {
        D <- read.csv(paste0(path, listFiles[i]), header = FALSE, sep = "", dec = ".")
        # The names of each column assign
        D <- setNames(D, c("Day", "Month", "Year", "PRECIP", "TMEAN"))
        if (info == TRUE) {
        #todo created methodNA zoo packages
            print("+---------------------------------------------------------+")
            print(paste0(path, listFiles[i]))
            #cat("Delete/Replace the rows contains the number -9999\n")
            na <- abs(length(D[D$PRECIP != -9999, ][, 1]) - length(D[, 1]))
            cat("The number of del/rep rows by column precipitation=", na, "\n")
            D <- D[D$PRECIP != -9999, ]
            na <- abs(length(D[D$TMEAN != -9999, ][, 1]) - length(D[, 1]))
            cat("The number of del/rep rows by column temp=", na, "\n")
            D <- D[D$TMEAN != -9999, ]
            print("Tail")
            print(tail(D))
            print("Structure")
            print(str(D))
            print("Summary")
            print(summary(D[4:5]))
            #print(summary(D))
            print("+---------------------------------------------------------+")
        } else {
            # Delete the rows contains the number -9999
            na <- abs(length(D[D$PRECIP != -9999, ][, 1]) - length(D[, 1]))
            D <- D[D$PRECIP != -9999, ]
            na <- abs(length(D[D$TMEAN != -9999, ][, 1]) - length(D[, 1]))
            D <- D[D$TMEAN != -9999, ]
        }
        # get rid of all observations with missing data
        D <- na.omit(D)
        endYear <- D[length(D[, 3]), 3]
        startYear <- D[1, 3]
        if (info == TRUE) {
            bt <- Sys.time()
            E <- eval16CliPars(substr(listFiles[i], 1, 5), D, D, startYear, endYear)
            et <- Sys.time()
            print(et-bt)
            
        } else {
            E <- eval16CliPars(substr(listFiles[i], 1, 5), D, D, startYear, endYear)
        }
        # Deleted row is marked as bad
        E <- na.omit(E[E$StartSG != -9999, ])
        #todo add tryCatch
        #print(str(E))
        print(head(E))
        print(summary(E[c(2,5,6,11,12,13,15,16,17,18,19,20,21,22)]))
        
        Sys.setenv(R_ZIPCMD = paste0(path, "/zip.exe"))  ## path to zip.exe
        require(openxlsx)  # # WriteXLSX
        #newName <- sub(".txt", ".par", listFiles[i], fixed=TRUE)
        #openxlsx::write.xlsx(E, file = paste0(path, "/cli2par/", newName , ".xlsx"))
        # Save result to list listE[i] <- E
        resultT[[i]] <- E
    }
    return(resultT)
}
```
###  For all of the weather stations included in the transect

```{r calculate_transect, echo=FALSE, message = FALSE, warnings = FALSE}
if (TRUE) {
    bt <- Sys.time()
    options(warn=-1)
    par.altai <- cli2par(paste0(mm_path, "/cli/altai/"), altai.files, 
        info = TRUE)
    options(warn=0)
    par.lena <- cli2par(paste0(mm_path, "/cli/lena/"), lena.files, info = TRUE)
    par.north <- cli2par(paste0(mm_path, "/cli/north/"), north.files, 
        info = TRUE)
    par.yenisei <- cli2par(paste0(mm_path, "/cli/yenisei/"), yenisei.files, 
        info = TRUE)
    et <- Sys.time()
    print(et-bt)
}   else {  # The calculation run parameters for a particular station

}

```
```{r test, eval=FALSE}
# http://rmarkdown.rstudio.com/authoring_rcodechunks.html
# http://zevross.com/blog/2014/07/09/making-use-of-external-r-code-in-knitr-and-r-markdown/
# To display R code without evaluating it, you specify the eval=FALSE chunk option:

# cli/lena/24051099999 SIKTJAH.txt  1
#par.lena <- cli2par(paste0(mm_path, "/cli/lena/"), lena.files, info = TRUE)
# cli/north/20982099999 VOLOCHANKA.txt 2


# https://www.rstudio.com/wp-content/uploads/2016/02/advancedR.pdf
# https://englianhu.files.wordpress.com/2016/05/advanced-r.pdf
# traceback()

#SA472 <- getCliStation(paste0(mm_path, "/cli/altai/"), altai.files[2])
#Y1971 <- get_one_year(SA472, 1971)

# This is not implemented yet.
# http://adv-r.had.co.nz/Exceptions-Debugging.html#debugging-techniques

```











